db:
  image: mysql:5.5
  environment:
    MYSQL_ROOT_PASSWORD: example
    MYSQL_DATABASE: wordpress
    MYSQL_USER: wordpress
    MYSQL_PASSWORD: wordpress

wp:
  build: .
  command: [ "/sbin/my_init", "--", "setuser", "wp", "bash", "-l", "-c", "while ! wp server --host=0.0.0.0 --docroot=/var/www; do sleep 5; done" ]
  links:
    - db:mysql
  ports:
    - 80:8080

setup-main:
  build: .
  links:
    - db:mysql
  volumes_from:
    - wp
  environment:
    WP_EXTRA_PHP: |-
      define('DISABLE_WP_CRON', true);
    CRON_D_WP: |-
      PATH=/usr/local/bin:$$PATH
      * * * * * wp wp cron event list --format=csv --fields=hook,next_run_relative --path=/var/www | awk -F ',' '$$2 == "now" {print $$1}' | xargs -r -l1 wp cron event run --path=/var/www
    WP_TITLE: Main Site
    WP_SUBDOMAINS: "yes"
    WP_URL: http://foobar.dev
    WP_ADMIN_USER: admin
    WP_ADMIN_PASSWORD: admin
    WP_ADMIN_EMAIL: webmaster+admin@foobar.net.nz
    WP_PLUGINS: |-
      amazon-s3-and-cloudfront
      amazon-web-services
      jetpack
      multisite-enhancements
      multisite-plugin-manager
      user-switching
      wordpress-mu-domain-mapping
      wp-ses
    GH_PLUGINS: |-
      WP-API/OAuth1
      WP-API/Basic-Auth
    GH_THEMES: |-
      CherryFramework/CherryFramework
    BB_KEY: qAMQvMs9L7ktMxNZwE
    BB_SECRET: pUnHEE9gAQvExenRwTC67a5vAyXLnfy6
    BB_PLUGINS: |-
      nickbreen/kidslink-plugin v1.5.7
    BB_THEMES: |-
      nickbreen/kidslink-theme v1.5.6
    WP_EXTRA_PHP: |-
      define('DISABLE_WP_CRON', true);
      define( 'SUNRISE', 'on' );
    WP_OPTIONS: |-
      foo {"foo":"FOO","bar":"BAR"}
    WP_COMMANDS: |-
      db query "UPDATE wp_site SET domain = '' WHERE domain = 'foobar.dev' AND 1=2"
      site list
      site create --slug=kidslink.dev --title=KidsLink --email=webmaster+kidslink@foobar.net.nz
      site list
      db query "UPDATE wp_blogs SET domain = 'kidslink.dev' WHERE domain = 'kidslink.foobar.dev'"
      option update siteurl http://kidslink.dev --url=http://kidslink.dev
      option update home http://kidslink.dev --url=http://kidslink.dev
      plugin activate kidslink-plugin --url=http://kidslink.dev
      theme activate kidslink-theme  --url=http://kidslink.dev
      rewrite structure /%postname%
      rewrite flush

setup-test:
  build: .
  links:
    - db:mysql
  volumes_from:
    - wp
  environment:
    WP_EXTRA_PHP: |-
      define('DISABLE_WP_CRON', true);
    CRON_D_WP: |-
      PATH=/usr/local/bin:$$PATH
      * * * * * wp wp cron event list --format=csv --fields=hook,next_run_relative --path=/var/www | awk -F ',' '$$2 == "now" {print $$1}' | xargs -r -l1 wp cron event run --path=/var/www
    WP_TITLE: foo//bar WordPress
    WP_SUBDOMAINS: "yes"
    WP_URL: http://foobar.dev
    WP_ADMIN_USER: admin
    WP_ADMIN_PASSWORD: admin
    WP_ADMIN_EMAIL: webmaster+foobar.admin@foobar.net.nz
    WP_PLUGINS: |-
      amazon-s3-and-cloudfront
      amazon-web-services
      jetpack
      multisite-enhancements
      multisite-plugin-manager
      user-switching
      wordpress-mu-domain-mapping
      wp-ses
    GH_PLUGINS: |-
      WP-API/OAuth1
      WP-API/Basic-Auth
    GH_THEMES: |-
      CherryFramework/CherryFramework
    BB_KEY: qAMQvMs9L7ktMxNZwE
    BB_SECRET: pUnHEE9gAQvExenRwTC67a5vAyXLnfy6
    BB_PLUGINS: |-
      nickbreen/kidslink-plugin v1.5.7
    BB_THEMES: |-
      nickbreen/kidslink-theme v1.5.6
    WP_EXTRA_PHP: |-
      define('DISABLE_WP_CRON', true);
      define( 'SUNRISE', 'on' );
    WP_OPTIONS: |-
      foo {"foo":"FOO","bar":"BAR"}
    WP_COMMANDS: |-
      db query "UPDATE wp_site SET domain = '' WHERE domain = 'foobar.dev' AND 1=2"
      site list
      site create --slug=kidslink.dev --title=KidsLink --email=webmaster+kidslink@foobar.net.nz
      site list
      db query "UPDATE wp_blogs SET domain = 'kidslink.dev' WHERE domain = 'kidslink.foobar.dev'"
      option update siteurl http://kidslink.dev --url=http://kidslink.dev
      option update home http://kidslink.dev --url=http://kidslink.dev
      plugin activate kidslink-plugin --url=http://kidslink.dev
      theme activate kidslink-theme  --url=http://kidslink.dev
      rewrite structure /%postname%
      rewrite flush
